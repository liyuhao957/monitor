# OPPO重复通知问题修复

## 问题描述
用户收到了两个OPPO快游戏的飞书更新通知，时间分别在10:00:21和10:01:17。

## 问题分析

### 根本原因（重新分析）
通过用户提供的关键信息和深入分析log.txt发现，真正的问题是**任务并发执行冲突**：

**触发场景**：用户为华为加载器生成AI通知模板时，触发了OPPO任务的重复执行

**关键时间线**：
1. **09:57:38** - 用户开始为华为任务获取页面内容进行AI预览
2. **10:00:17** - 关键时刻：
   - OPPO任务开始执行
   - **同时**华为任务也在执行
   - **OPPO任务被执行了两次**（并发冲突）
   - 导致两次"Change detected"和两个通知

### 技术原因
1. **资源竞争**：前端AI预览调用`/api/content/fetch`与定时任务同时执行
2. **浏览器实例冲突**：多个任务同时访问Playwright浏览器资源
3. **状态混乱**：并发执行导致存储状态读写冲突
4. **缺乏互斥机制**：没有防止任务并发执行的保护机制

## 解决方案

### 主要方案：任务执行互斥锁（根本性修复）

#### 1.1 全局任务执行锁
- 添加`asyncio.Lock()`全局互斥锁
- 确保同一时间只有一个任务在执行
- 适用于定时任务和API调用

#### 1.2 锁的超时机制
- 30秒锁获取超时，防止死锁
- 详细的锁获取和释放日志
- 异常情况下的锁释放保证

#### 1.3 函数重构
- `run_task()` -> 锁包装器 + `_run_task_internal()`
- `fetch_page_content()` -> 锁包装器 + `_fetch_page_content_internal()`
- 保持原有逻辑不变，只添加互斥保护

### 辅助方案：防重复通知机制（额外保护）

#### 2.1 内容哈希缓存
- 基于内容SHA256哈希值防重复
- 5分钟冷却期机制
- 自动清理过期缓存

#### 2.2 通知发送前检查
- 在发送通知前进行重复内容检查
- 记录通知发送时间和内容哈希
- 提供详细的抑制日志

### 存储状态增强（调试辅助）

#### 3.1 增强storage.py
- 添加详细的调试日志
- 新增`has_baseline()`函数进行更严格的基线检查
- 改进错误处理和状态验证

## 修改的文件

### backend/app/services/storage.py
- 添加logging支持
- 增强`_get_storage_path()`调试信息
- 改进`get_last_result()`错误处理
- 新增`has_baseline()`函数

### backend/app/services/monitor.py
- 添加防重复通知缓存机制
- 新增`_should_send_notification()`函数
- 增强存储状态检查逻辑
- 添加详细的内容比较日志
- 在通知发送前添加重复检查

## 预期效果

1. **根本性修复**：消除任务并发执行冲突，确保任务串行执行
2. **资源保护**：防止多个任务同时访问浏览器资源导致的状态混乱
3. **防护机制**：即使出现异常情况，也能防止5分钟内的重复通知
4. **调试友好**：提供详细的锁获取/释放日志便于问题追踪
5. **性能优化**：虽然任务串行执行，但避免了资源竞争和重复执行
6. **向后兼容**：不影响现有功能，只是增强稳定性

## AI提示词重新设计

### 新的分阶段提示词策略

**设计原则：**
- 完全重写提示词，采用分阶段引导方式
- 先分析HTML结构，再设计提取规则
- 强制AI按4个阶段顺序思考，不允许跳跃

**4个工作阶段：**
1. **HTML结构深度分析**：逐层分析标签结构和数据组织方式
2. **字段定位与映射**：建立字段与HTML位置的精确一对一映射
3. **提取策略设计**：为每个字段单独设计正则表达式，绝不重复使用
4. **验证与优化**：模拟执行并验证提取结果的正确性

**关键改进：**
- 增加ANALYSIS部分要求AI展示分析过程
- 添加提取规则独立性验证机制
- 强调每个字段必须使用不同的正则表达式
- 要求AI验证每个正则能提取到什么内容
- **新增**：限制AI只能使用标准Jinja2语法，禁止自定义过滤器

## 发现的新问题和修复

### 问题3：Jinja2模板渲染失败
**问题描述**：AI生成的模板使用了不存在的自定义过滤器`format_datetime`，导致模板渲染失败，系统降级使用备用消息。

**根本原因**：AI提示词没有明确限制只能使用标准Jinja2语法。

**解决方案**：
- 在系统提示词中明确禁止使用自定义过滤器
- 提供可用的标准Jinja2过滤器列表
- 要求使用current_time变量而不是now()函数
- 强调只能使用标准Jinja2语法

## 测试建议

1. **并发测试**：在前端为任务生成AI模板的同时观察其他任务的执行情况
2. **锁机制验证**：检查日志中的锁获取和释放信息
3. **AI提示词测试**：重新生成OPPO任务的AI模板，验证新提示词效果
4. **提取规则验证**：检查生成的正则表达式是否独立且正确
5. **Jinja2模板验证**：确保生成的模板只使用标准语法，能正常渲染
6. **性能测试**：验证串行执行不会显著影响任务执行效率
7. **异常处理**：测试锁超时和异常情况下的处理
8. **功能完整性**：确保正常的变更检测和通知功能不受影响
